{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'search.css' %}">

<div class="page-container">

    <!-- Left Sidebar (Filter) -->
    <aside class="sidebar">
        <h2>Filter</h2>

        <!-- Price Level -->
        <div class="section price">
            <label>Price Level</label>
            <div class="two-col">
                <button data-value="1">$</button>
                <button data-value="2">$$</button>
                <button data-value="3">$$$</button>
                <button data-value="4">$$$$</button>
            </div>
        </div>

        <!-- Category -->
        <div class="section category">
            <label>Category</label>
            <div class="two-col">
                <button data-value="restaurant">üçΩ Restaurant</button>
                <button data-value="museum">üèõ Museum</button>
                <button data-value="park">üèû Outdoors</button>
                <button data-value="tour">üé´ Tours</button>
            </div>
        </div>

        <!-- Rating -->
        <div class="section rating">
            <label>Minimum Rating</label>
            <div class="two-col">
                <button data-value="1">1+</button>
                <button data-value="2">2+</button>
                <button data-value="3">3+</button>
                <button data-value="4">4+</button>
            </div>
        </div>

        <div class="action-buttons">
            <button id="clear-filters" class="clear">Clear All</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Bar -->
        <form method="get" action="{% url 'search' %}" class="search-bar-container">
            <input type="text" id="search-query" name="q" class="search-input" placeholder="Search destinations, activities..." value="{{ query }}">
            <button type="submit" class="search-btn">Search</button>
        </form>
        <div id="map-container" style="width:100%; height:80%; margin-top:20px;"></div>
    </main>

    <!-- Right Sidebar (Results) -->
    <aside class="results-panel">
        <h2>Search Results:</h2>
        <div id="results" class="activity-cards">
            {% if results %}
                {% for activity in results %}
                    <div class="activity-card activity-item" 
                         data-lat="{{ activity.location.lat }}" 
                         data-lng="{{ activity.location.lng }}"
                         data-name="{{ activity.name }}">
                        {% if activity.photos %}<img src="{{ activity.photos.0 }}" class="activity-photo" />{% endif %}
                        <div class="activity-info">
                            <h3>{{ activity.name }}</h3>
                            {% if activity.address %}<p class="address">{{ activity.address }}</p>{% endif %}
                            {% if activity.rating %}<p class="rating">‚≠ê {{ activity.rating }} ({% if activity.user_ratings_total %}{{ activity.user_ratings_total }} reviews{% else %}0 reviews{% endif %})</p>{% endif %}
                            {% if activity.types %}<p class="types">Type: {{ activity.types|join:", " }}</p>{% endif %}
                            {% if activity.price_level %}<p class="price">Price Level: {{ activity.price_level }}</p>{% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No activities found.</p>
            {% endif %}
        </div>
    </aside>

</div>

<!-- Scripts -->
<script>
let map;
let marker;

// Initialize Google Map
function initMap() {
    map = new google.maps.Map(document.getElementById('map-container'), {
        center: { lat: 0, lng: 0 },
        zoom: 2
    });

    document.querySelectorAll('.activity-item').forEach(item => {
        item.addEventListener('click', () => {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            const name = item.dataset.name;

            map.setCenter({ lat, lng });
            map.setZoom(14);

            if (marker) marker.setMap(null);

            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: name
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${name}</strong>`
            });
            infoWindow.open(map, marker);
        });
    });
}

// Load Google Maps API
function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
}
loadGoogleMaps();

// Filter
const selectedFilters = { price: new Set(), category: new Set(), rating: new Set() };

document.querySelectorAll('.sidebar .section button').forEach(btn => {
    btn.addEventListener('click', () => {
        const section = btn.closest('.section').classList[1];
        const value = btn.dataset.value;

        btn.classList.toggle('selected');
        if (btn.classList.contains('selected')) {
            selectedFilters[section].add(value);
        } else {
            selectedFilters[section].delete(value);
        }

        applyFilters();
    });
});

document.getElementById('clear-filters').addEventListener('click', () => {
    document.querySelectorAll('.sidebar .section button').forEach(btn => btn.classList.remove('selected'));
    for (let key in selectedFilters) selectedFilters[key].clear();
    applyFilters();
});

function applyFilters() {
    const cards = document.querySelectorAll('.activity-item');

    cards.forEach(card => {
        const price = card.querySelector('.price') ? card.querySelector('.price').textContent.replace('Price Level: ','') : '';
        const category = card.querySelector('.types') ? card.querySelector('.types').textContent.replace('Type: ','').toLowerCase().split(', ') : [];
        const rating = card.querySelector('.rating') 
            ? parseFloat(card.querySelector('.rating').textContent.match(/‚≠ê\s*([\d.]+)/)[1]) 
            : 0;

        const priceMatch = selectedFilters.price.size === 0 || selectedFilters.price.has(price);
        const categoryMatch = selectedFilters.category.size === 0 || Array.from(selectedFilters.category).some(cat => category.includes(cat));
        const ratingMatch = selectedFilters.rating.size === 0 || Array.from(selectedFilters.rating).some(r => rating >= parseFloat(r));

        card.style.display = (priceMatch && categoryMatch && ratingMatch) ? '' : 'none';
    });
}

</script>

{% endblock %}
