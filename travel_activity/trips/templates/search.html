{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'search.css' %}">

<div class="page-container">

    <!-- Left Sidebar (Filter) -->
    <aside class="sidebar">
        <h2>Filter</h2>

        <!-- Price Level -->
        <div class="section price">
            <label>Price Level</label>
            <div class="two-col">
                <button data-value="1">$</button>
                <button data-value="2">$$</button>
                <button data-value="3">$$$</button>
                <button data-value="4">$$$$</button>
            </div>
        </div>

        <!-- Category -->
        <div class="section category">
            <label>Category</label>
            <div class="two-col">
                <button data-value="restaurant">üçΩ Restaurant</button>
                <button data-value="museum">üèõ Museum</button>
                <button data-value="park">üèû Outdoors</button>
                <button data-value="tour">üé´ Tours</button>
            </div>
        </div>

        <!-- Rating -->
        <div class="section rating">
            <label>Minimum Rating</label>
            <div class="two-col">
                <button data-value="1">1+</button>
                <button data-value="2">2+</button>
                <button data-value="3">3+</button>
                <button data-value="4">4+</button>
            </div>
        </div>

        <div class="action-buttons">
            <button id="clear-filters" class="clear">Clear All</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Search Bar -->
        <form method="get" action="{% url 'search' %}" class="search-bar-container">
            <input type="text" id="search-query" name="q" class="search-input" placeholder="Search destinations, activities..." value="{{ query }}">
            <button type="submit" class="search-btn">Search</button>
        </form>
        <div id="map-container" style="width:100%; height:80%; margin-top:20px;"></div>
    </main>

    <!-- Right Sidebar (Results) -->
    <aside class="results-panel">
        <h2>Search Results:</h2>
        <div id="results" class="activity-cards">
            {% if results %}
                {% for activity in results %}
                    <div class="activity-card activity-item"
                         data-lat="{{ activity.location.lat }}"
                         data-lng="{{ activity.location.lng }}"
                         data-name="{{ activity.name }}"
                         data-place-id="{{ activity.place_id }}"
                         data-address="{{ activity.address }}"
                         data-rating="{{ activity.rating|default:0 }}"
                         data-price="{{ activity.price_level|default:0 }}"
                         data-types="{{ activity.types|join:',' }}"
                         data-photo="{% if activity.photos %}{{ activity.photos.0 }}{% endif %}">
                        {% if activity.photos %}<img src="{{ activity.photos.0 }}" class="activity-photo" />{% endif %}
                        <button class="heart-btn" onclick="toggleSaveActivity(this, event)" title="Add to trip">
                            <span class="heart-icon">+</span>
                        </button>
                        <div class="activity-info">
                            <h3>{{ activity.name }}</h3>
                            {% if activity.address %}<p class="address">{{ activity.address }}</p>{% endif %}
                            {% if activity.rating %}<p class="rating">‚≠ê {{ activity.rating }} ({% if activity.user_ratings_total %}{{ activity.user_ratings_total }} reviews{% else %}0 reviews{% endif %})</p>{% endif %}
                            {% if activity.types %}<p class="types">Type: {{ activity.types|join:", " }}</p>{% endif %}
                            {% if activity.price_level %}<p class="price">Price Level: {{ activity.price_level }}</p>{% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No activities found.</p>
            {% endif %}
        </div>
    </aside>

</div>

<!-- Trip Selection Modal -->
<div id="trip-modal" class="trip-modal" style="display: none;">
    <div class="trip-modal-content">
        <div class="trip-modal-header">
            <h2>Add to Trip</h2>
            <button class="close-modal" onclick="closeTripModal()">&times;</button>
        </div>
        <div class="trip-modal-body">
            <p class="activity-name-display"></p>
            <div class="trip-list" id="trip-list">
                <!-- Trips will be loaded here -->
            </div>
            <button class="create-new-trip-btn" onclick="showCreateTripForm()">
                + Create New Trip
            </button>
            <div id="create-trip-form" style="display: none;">
                <h3>New Trip</h3>
                <input type="text" id="new-trip-name" placeholder="Trip name (e.g., Ireland 2025)" required>
                <input type="date" id="new-trip-start" required>
                <input type="date" id="new-trip-end" required>
                <button onclick="createNewTrip()">Create Trip</button>
                <button onclick="cancelCreateTrip()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let map;
let marker;

// Initialize Google Map
function initMap() {
    map = new google.maps.Map(document.getElementById('map-container'), {
        center: { lat: 0, lng: 0 },
        zoom: 2
    });

    document.querySelectorAll('.activity-item').forEach(item => {
        item.addEventListener('click', () => {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            const name = item.dataset.name;

            map.setCenter({ lat, lng });
            map.setZoom(14);

            if (marker) marker.setMap(null);

            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: name
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${name}</strong>`
            });
            infoWindow.open(map, marker);
        });
    });
}

// Load Google Maps API
function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
}
loadGoogleMaps();

// Filter
const selectedFilters = { price: new Set(), category: new Set(), rating: new Set() };

document.querySelectorAll('.sidebar .section button').forEach(btn => {
    btn.addEventListener('click', () => {
        const section = btn.closest('.section').classList[1];
        const value = btn.dataset.value;

        btn.classList.toggle('selected');
        if (btn.classList.contains('selected')) {
            selectedFilters[section].add(value);
        } else {
            selectedFilters[section].delete(value);
        }

        applyFilters();
    });
});

document.getElementById('clear-filters').addEventListener('click', () => {
    document.querySelectorAll('.sidebar .section button').forEach(btn => btn.classList.remove('selected'));
    for (let key in selectedFilters) selectedFilters[key].clear();
    applyFilters();
});

function applyFilters() {
    const cards = document.querySelectorAll('.activity-item');

    cards.forEach(card => {
        const price = card.querySelector('.price') ? card.querySelector('.price').textContent.replace('Price Level: ','') : '';
        const category = card.querySelector('.types') ? card.querySelector('.types').textContent.replace('Type: ','').toLowerCase().split(', ') : [];
        const rating = card.querySelector('.rating') 
            ? parseFloat(card.querySelector('.rating').textContent.match(/‚≠ê\s*([\d.]+)/)[1]) 
            : 0;

        const priceMatch = selectedFilters.price.size === 0 || selectedFilters.price.has(price);
        const categoryMatch = selectedFilters.category.size === 0 || Array.from(selectedFilters.category).some(cat => category.includes(cat));
        const ratingMatch = selectedFilters.rating.size === 0 || Array.from(selectedFilters.rating).some(r => rating >= parseFloat(r));

        card.style.display = (priceMatch && categoryMatch && ratingMatch) ? '' : 'none';
    });
}

// Global variable to store current activity data
let currentActivityData = null;
let currentHeartBtn = null;

// Toggle save activity - now shows trip selection modal
function toggleSaveActivity(btn, event) {
    event.stopPropagation(); // Prevent card click event

    const card = btn.closest('.activity-item');
    const heartIcon = btn.querySelector('.heart-icon');

    // Check if already saved (checkmark)
    const isSaved = heartIcon.textContent === '‚úì';

    if (isSaved) {
        alert('This activity is already in one of your trips!');
        return;
    }

    // Store activity data
    currentActivityData = {
        place_id: card.dataset.placeId,
        name: card.dataset.name,
        address: card.dataset.address,
        lat: parseFloat(card.dataset.lat),
        lng: parseFloat(card.dataset.lng),
        rating: parseFloat(card.dataset.rating) || null,
        price_level: card.dataset.price || null,
        types: card.dataset.types.split(','),
        photo_url: card.dataset.photo || null
    };

    currentHeartBtn = btn;

    // Show modal and load trips
    showTripModal();
}

// Show trip selection modal
function showTripModal() {
    const modal = document.getElementById('trip-modal');
    const activityName = document.querySelector('.activity-name-display');

    activityName.textContent = `Add "${currentActivityData.name}" to:`;
    modal.style.display = 'flex';

    // Load user's trips
    loadUserTrips();
}

// Close trip modal
function closeTripModal() {
    const modal = document.getElementById('trip-modal');
    modal.style.display = 'none';
    document.getElementById('create-trip-form').style.display = 'none';
}

// Load user's trips
function loadUserTrips() {
    fetch('/api/trips/user-trips/')
    .then(response => response.json())
    .then(data => {
        const tripList = document.getElementById('trip-list');
        tripList.innerHTML = '';

        if (data.trips && data.trips.length > 0) {
            data.trips.forEach(trip => {
                const tripCard = document.createElement('div');
                tripCard.className = 'trip-card';
                tripCard.innerHTML = `
                    <h4>${trip.destination}</h4>
                    <p>${trip.start_date} to ${trip.end_date}</p>
                    <p class="activity-count">${trip.activity_count || 0} activities</p>
                `;
                tripCard.onclick = () => addActivityToTrip(trip.id);
                tripList.appendChild(tripCard);
            });
        } else {
            tripList.innerHTML = '<p class="no-trips">No trips yet. Create your first trip!</p>';
        }
    })
    .catch(error => {
        console.error('Error loading trips:', error);
        showNotification('Failed to load trips', 'error');
    });
}

// Add activity to selected trip
function addActivityToTrip(tripId) {
    fetch('/api/trips/add-activity/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            trip_id: tripId,
            activity_data: currentActivityData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update icon to checkmark
            const heartIcon = currentHeartBtn.querySelector('.heart-icon');
            heartIcon.textContent = '‚úì';
            currentHeartBtn.classList.add('saved');

            showNotification(`Added to ${data.trip_name}!`);
            closeTripModal();
        } else {
            showNotification(data.message || 'Error adding activity', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to add activity. Please try again.', 'error');
    });
}

// Show create trip form
function showCreateTripForm() {
    document.getElementById('create-trip-form').style.display = 'block';
}

// Cancel create trip
function cancelCreateTrip() {
    document.getElementById('create-trip-form').style.display = 'none';
    document.getElementById('new-trip-name').value = '';
    document.getElementById('new-trip-start').value = '';
    document.getElementById('new-trip-end').value = '';
}

// Create new trip
function createNewTrip() {
    const name = document.getElementById('new-trip-name').value;
    const startDate = document.getElementById('new-trip-start').value;
    const endDate = document.getElementById('new-trip-end').value;

    if (!name || !startDate || !endDate) {
        alert('Please fill in all fields');
        return;
    }

    fetch('/api/trips/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            destination: name,
            start_date: startDate,
            end_date: endDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Trip created!');
            cancelCreateTrip();
            loadUserTrips();
        } else {
            showNotification(data.message || 'Error creating trip', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to create trip', 'error');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to show notification
function showNotification(message, type = 'success') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#0073b1' : '#ff4757'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS animation for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

</script>

{% endblock %}
