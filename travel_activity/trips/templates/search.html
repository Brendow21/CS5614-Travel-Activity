{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'search.css' %}">

<div class="page-container">

    <!-- Left Sidebar (Filter) -->
    <aside class="sidebar">
        <h2>Filter</h2>

        <!-- Price Range -->
        <div class="section">
            <label>Price Range</label>
            <div class="two-col">
                <input type="number" placeholder="Min Price">
                <input type="number" placeholder="Max Price">
            </div>
        </div>

        <!-- Duration -->
        <div class="section">
            <label>Duration</label>
            <div class="two-col">
                <button>Quick (&lt; 2 hours)</button>
                <button>Half-day (2‚Äì4 hours)</button>
                <button>Full-day (4‚Äì8 hours)</button>
                <button>Multi-day (8+ hours)</button>
            </div>
        </div>

        <!-- Category -->
        <div class="section">
            <label>Category</label>
            <div class="two-col">
                <button>üçΩ Restaurant</button>
                <button>üèõ Museum</button>
                <button>üèû Outdoors</button>
                <button>üé´ Tours</button>
            </div>
        </div>

        <!-- Rating -->
        <div class="section">
            <label>Minimum Rating</label>
            <div class="two-col">
                <button>‚ú® 3.5+</button>
                <button>‚ú® 4+</button>
                <button>‚ú® 4.5+</button>
            </div>
        </div>

        <!-- Accessibility -->
        <div class="section">
            <label>Accessibility</label>
            <div class="two-col">
                <button>ü¶Ω Wheelchair Accessible</button>
                <button>üêï Pet-Friendly</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="clear">Clear All</button>
            <button class="apply">Apply Filters</button>
        </div>
    </aside>

    <!-- Main Content (Map) -->
    <main class="main-content">
        <!-- Search Bar -->
        <form method="get" action="{% url 'search' %}" class="search-bar-container">
            <input type="text" id="search-query" name="q" class="search-input" placeholder="Search destinations, activities..." value="{{ query }}">
            <button type="submit" class="search-btn">Search</button>
        </form>
        <div id="map-container" style="width:100%; height:80%; margin-top:20px;"></div>
    </main>

    <!-- Right Sidebar (Results) -->
    <aside class="recommended-panel">
        <h2>Search Results:</h2>
        <div id="results" class="activity-cards">
            {% if results %}
                {% for activity in results %}
                    <div class="activity-card activity-item" 
                         data-lat="{{ activity.location.lat }}" 
                         data-lng="{{ activity.location.lng }}"
                         data-name="{{ activity.name }}">
                        {% if activity.photos %}
                            <img src="{{ activity.photos.0 }}" class="activity-photo" />
                        {% endif %}

                        <div class="activity-info">
                            <h3>{{ activity.name }}</h3>
                            {% if activity.address %}<p class="address">{{ activity.address }}</p>{% endif %}

                            {% if activity.rating %}
                                <p class="rating">
                                    ‚≠ê {{ activity.rating }} 
                                    ({% if activity.user_ratings_total %}{{ activity.user_ratings_total }} reviews{% else %}0 reviews{% endif %})
                                </p>
                            {% endif %}

                            {% if activity.types %}
                                <p class="types">Type: {{ activity.types|join:", " }}</p>
                            {% endif %}

                            {% if activity.opening_hours %}
                                <p class="hours">{% if activity.opening_hours.open_now %}Open Now{% else %}Closed{% endif %}</p>
                            {% endif %}

                            {% if activity.price_level %}
                                <p class="price">Price Level: {{ activity.price_level }}</p>
                            {% endif %}

                            {% if activity.distance %}
                                <p class="distance">Distance: {{ activity.distance }} m</p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No activities found.</p>
            {% endif %}
        </div>
    </aside>

</div>

<!-- Google Maps JS -->
<script>
let map;
let marker;

// Initialize map
function initMap() {
    map = new google.maps.Map(document.getElementById('map-container'), {
        center: { lat: 0, lng: 0 },
        zoom: 2
    });

    // Make existing activity cards clickable
    document.querySelectorAll('.activity-item').forEach(item => {
        item.addEventListener('click', () => {
            const lat = parseFloat(item.dataset.lat);
            const lng = parseFloat(item.dataset.lng);
            const name = item.dataset.name;

            // Center map and add marker
            map.setCenter({ lat, lng });
            map.setZoom(14);

            // Remove previous marker
            if (marker) marker.setMap(null);

            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: name
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${name}</strong>`
            });
            infoWindow.open(map, marker);
        });
    });
}

// Load Google Maps API
function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
}

loadGoogleMaps();
</script>

{% endblock %}
