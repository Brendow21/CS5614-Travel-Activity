{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'saved.css' %}">

<div class="saved-container">

    <!-- Page Header -->
    <header class="saved-header">
        <div class="header-content">
            <h1>My Trips</h1>
            <p class="subtitle">Plan and organize your travel adventures</p>
        </div>
        <div class="header-stats">
            <span class="stat-badge">{{ trips_with_activities|length }} Trip{{ trips_with_activities|length|pluralize }}</span>
        </div>
    </header>

    <!-- Trips List -->
    {% if trips_with_activities %}
        <div class="trips-list">
            {% for trip_data in trips_with_activities %}
            <div class="trip-section">
                <!-- Trip Header -->
                <div class="trip-header" onclick="toggleTripActivities({{ trip_data.trip.id }})">
                    <div class="trip-info">
                        <h2 class="trip-title">{{ trip_data.trip.destination }}</h2>
                        <div class="trip-meta">
                            <span class="trip-dates">
                                üìÖ {{ trip_data.trip.start_date|date:"M d, Y" }} - {{ trip_data.trip.end_date|date:"M d, Y" }}
                            </span>
                            <span class="trip-activity-count">
                                üéØ {{ trip_data.activity_count }} activit{{ trip_data.activity_count|pluralize:"y,ies" }}
                            </span>
                        </div>
                    </div>
                    <button class="expand-btn" id="expand-btn-{{ trip_data.trip.id }}">
                        <span>‚ñº</span>
                    </button>
                </div>

                <!-- Activities Grid (Collapsible) -->
                <div class="activities-grid collapsed" id="activities-{{ trip_data.trip.id }}">
                    {% if trip_data.activities %}
                        {% for trip_activity in trip_data.activities %}
                        <div class="activity-card" data-activity-id="{{ trip_activity.activity.activity_id }}">
                            <!-- Card Image -->
                            <div class="card-image">
                                {% if trip_activity.activity.photo_url %}
                                    <img src="{{ trip_activity.activity.photo_url }}" alt="{{ trip_activity.activity.title }}">
                                {% else %}
                                    <div class="placeholder-image">
                                        <span class="placeholder-icon">üìç</span>
                                    </div>
                                {% endif %}
                                <button class="remove-btn" onclick="removeActivity(event, {{ trip_data.trip.id }}, {{ trip_activity.activity.activity_id }})" title="Remove from trip">
                                    <span>‚úï</span>
                                </button>
                                <span class="category-tag">{{ trip_activity.activity.category }}</span>
                            </div>

                            <!-- Card Content -->
                            <div class="card-content">
                                <h3 class="card-title">{{ trip_activity.activity.title }}</h3>
                                <p class="card-location">
                                    <span class="location-icon">üìç</span>
                                    {{ trip_activity.activity.location }}
                                </p>

                                <div class="card-meta">
                                    {% if trip_activity.activity.rating %}
                                    <span class="rating">
                                        <span class="star">‚≠ê</span>
                                        {{ trip_activity.activity.rating }}
                                    </span>
                                    {% endif %}

                                    <span class="price">${{ trip_activity.activity.cost }}</span>

                                    {% if trip_activity.activity.duration %}
                                    <span class="duration">
                                        <span class="clock-icon">üïê</span>
                                        {{ trip_activity.activity.duration }} min
                                    </span>
                                    {% endif %}
                                </div>

                                {% if trip_activity.notes %}
                                <div class="activity-notes">
                                    <strong>Notes:</strong> {{ trip_activity.notes }}
                                </div>
                                {% endif %}

                                <div class="card-footer">
                                    <span class="added-date">Added {{ trip_activity.added_at|timesince }} ago</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-activities">
                            <p>No activities added yet. Start searching and add activities to this trip!</p>
                            <a href="{% url 'search' %}" class="add-activity-btn">+ Add Activities</a>
                        </div>
                    {% endif %}
                </div>

                <!-- Trip Actions -->
                <div class="trip-actions collapsed" id="actions-{{ trip_data.trip.id }}">
                    <button class="action-btn map-btn" onclick="window.location.href='{% url 'trip-map' trip_data.trip.id %}'">
                        üó∫Ô∏è View Map
                    </button>
                    <button class="action-btn search-btn" onclick="window.location.href='{% url 'search' %}'">
                        + Add More Activities
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteTrip({{ trip_data.trip.id }}, '{{ trip_data.trip.destination }}')">
                        üóëÔ∏è Delete Trip
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-icon">‚úàÔ∏è</div>
            <h2>No trips planned yet</h2>
            <p>Start planning your next adventure by creating a trip and adding activities!</p>
            <a href="{% url 'search' %}" class="explore-btn">Start Planning</a>
        </div>
    {% endif %}

</div>

<!-- JavaScript -->
<script>
// Toggle trip activities visibility
function toggleTripActivities(tripId) {
    const activitiesDiv = document.getElementById(`activities-${tripId}`);
    const actionsDiv = document.getElementById(`actions-${tripId}`);
    const expandBtn = document.getElementById(`expand-btn-${tripId}`);

    activitiesDiv.classList.toggle('collapsed');
    actionsDiv.classList.toggle('collapsed');

    // Rotate arrow
    if (activitiesDiv.classList.contains('collapsed')) {
        expandBtn.querySelector('span').textContent = '‚ñº';
    } else {
        expandBtn.querySelector('span').textContent = '‚ñ≤';
    }
}

// Remove activity from trip
function removeActivity(event, tripId, activityId) {
    event.stopPropagation();

    if (!confirm('Remove this activity from the trip?')) {
        return;
    }

    fetch(`/api/trips/${tripId}/remove-activity/${activityId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove card from DOM
            const card = event.target.closest('.activity-card');
            card.remove();

            // Update activity count
            const activityCountSpan = document.querySelector(`#activities-${tripId}`).closest('.trip-section').querySelector('.trip-activity-count');
            const currentCount = parseInt(activityCountSpan.textContent.match(/\d+/)[0]);
            const newCount = currentCount - 1;
            activityCountSpan.textContent = `üéØ ${newCount} activit${newCount === 1 ? 'y' : 'ies'}`;

            // If no activities left, show empty message
            if (newCount === 0) {
                const activitiesGrid = document.getElementById(`activities-${tripId}`);
                activitiesGrid.innerHTML = `
                    <div class="empty-activities">
                        <p>No activities added yet. Start searching and add activities to this trip!</p>
                        <a href="/search/" class="add-activity-btn">+ Add Activities</a>
                    </div>
                `;
            }

            showNotification('Activity removed from trip');
        } else {
            showNotification('Failed to remove activity', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to remove activity', 'error');
    });
}

// Delete trip
function deleteTrip(tripId, tripName) {
    if (!confirm(`Delete trip "${tripName}"? This will remove all activities from this trip.`)) {
        return;
    }

    fetch(`/api/trips/${tripId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Trip deleted');
            location.reload();
        } else {
            showNotification('Failed to delete trip', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to delete trip', 'error');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to show notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#0073b1' : '#ff4757'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}
